#!/usr/bin/bash

set -o pipefail

pre_config_env=$(mktemp)
post_config_env=$(mktemp)
in_makefile=Makefile.in
in_secrets=../.secrets.gpg
out_secrets=.secrets
out_envfile=.env.conf
out_macrosfile=macros.m4
out_makefile=Makefile

printenv > $pre_config_env

# OPTIONS
WITH_CLICKUP_TARGET=IE
WITH_DEPLOY_TARGET=IE_CLOUD
WITH_GCLOUD_TARGET=PN
export CLICKPIE_SERVER_URL_PUBLIC=
export CLICKPIE_SERVER_URL_LOCAL=
export PREFIX=.
export LOGLEVEL=debug

# EXPORT until set +o allexport
# --------------------------------------------------------------------------------
set -o allexport

# App description
APP_NAME=clickpie-software
APP_VERSION=0.0.1
APP_VVERSION=v${APP_VERSION}
APP_DISTNAME=${APP_NAME}-${APP_VVERSION}
API_VERSION=1
API_VVERSION=v${API_VERSION}

# App directories
PKGDIR=.
PKGDIR_ABS=$(pwd)
SRCDIR=${PKGDIR}/src
SRCDIR_ABS=${PKGDIR_ABS}/src
BUILDIR=${PKGDIR}/build
BUILDIR_ABS=${PKGDIR_ABS}/build
CACHEDIR=${PREFIX}/var
TEMPDIR=${PREFIX}/var
CONFDIR=${PREFIX}/config

# Miscellaneous
MODE=production
NODE_ENV=production

# Clickup credentials
CLICKUP_LOGIN_USERNAME=
CLICKUP_LOGIN_PASS=
CLICKUP_LOGIN_AUTH_TOKEN=

# Clickup API url
CLICKUP_API_URL='https://api.clickup.com/api/v2'

# clickpie-server, servicing both UI clients and API clients
# public url
CLICKPIE_SERVER_URL_PUBLIC_SCHEME=
CLICKPIE_SERVER_URL_PUBLIC_PORT=
CLICKPIE_SERVER_URL_PUBLIC_HOSTNAME=
# local url
CLICKPIE_SERVER_URL_LOCAL_SCHEME=
CLICKPIE_SERVER_URL_LOCAL_PORT=
CLICKPIE_SERVER_URL_LOCAL_HOSTNAME=
# clickpie-api, serviced by clickpie-server
# public url
CLICKPIE_API_URL_PUBLIC_SCHEME=
CLICKPIE_API_URL_PUBLIC_PORT=
CLICKPIE_API_URL_PUBLIC_HOSTNAME=
CLICKPIE_API_URL_PUBLIC=
# local url
CLICKPIE_API_URL_LOCAL_SCHEME=
CLICKPIE_API_URL_LOCAL_PORT=
CLICKPIE_API_URL_LOCAL_HOSTNAME=
CLICKPIE_API_URL_LOCAL=

set +o allexport

main() {
  parse_args "$@"
  set -- "${POSARGS[@]}"
  debug "Config: $(quote $CONFIG)"
  debug "Clickup login: $(quote $CLICKUP_LOGIN)"


  echo Configuring...

  printf "Decrypting secrets...|%s\n" "$out_secrets"
  if ! ( [ -f "$out_secrets" ] || gpg --decrypt --quiet "$in_secrets" > "$out_secrets" ); then
    error "Failed to decrypt $in_secrets"
  fi
  source "$out_secrets"

  printf "Resolving --with-clickup-target...|%s\n" "$WITH_CLICKUP_TARGET"
  CLICKUP_LOGIN_TARGET=CLICKUP_LOGIN_${WITH_CLICKUP_TARGET}
  CLICKUP_LOGIN_USERNAME="$(expand "${CLICKUP_LOGIN_TARGET}_USERNAME")"
  CLICKUP_LOGIN_PASS="$(expand "${CLICKUP_LOGIN_TARGET}_PASS")"
  CLICKUP_LOGIN_AUTH_TOKEN="$(expand "${CLICKUP_LOGIN_TARGET}_TOKEN")"

  # clickpie-server, servicing both UI clients and API clients
  # public url
  printf "Resolving --server-public-url...|%s\n" "$CLICKPIE_SERVER_URL_PUBLIC"
  read -r scheme hostname port < <(parseUrl "$CLICKPIE_SERVER_URL_PUBLIC")
  if [[ "$scheme" == '' || "$hostname" == '' || "$port" == '' ]]; then
    error 'clickpie-server public url missing either scheme, hostname or port'
  fi
  CLICKPIE_SERVER_URL_PUBLIC_SCHEME="$scheme"
  CLICKPIE_SERVER_URL_PUBLIC_PORT="$port"
  CLICKPIE_SERVER_URL_PUBLIC_HOSTNAME="$hostname"
  CLICKPIE_SERVER_URL_PUBLIC_URL="${scheme}"://"${hostname}":"${port}"
  # local url
  printf "Resolving --server-local-url...|%s\n" "$CLICKPIE_SERVER_URL_LOCAL"
  read -r scheme hostname port < <(parseUrl "$CLICKPIE_SERVER_URL_LOCAL")
  if [[ "$scheme" == '' || "$hostname" == '' || "$port" == '' ]]; then
    error 'clickpie-server local url missing either scheme, hostname or port'
  fi
  CLICKPIE_SERVER_URL_LOCAL_SCHEME="$scheme"
  CLICKPIE_SERVER_URL_LOCAL_PORT="$port"
  CLICKPIE_SERVER_URL_LOCAL_HOSTNAME="$hostname"
  CLICKPIE_SERVER_URL_LOCAL="${scheme}"://"${hostname}":"${port}"

  # clickpie-api, serviced by clickpie-server
  # public url
  CLICKPIE_API_URL_PUBLIC_SCHEME="${CLICKPIE_SERVER_URL_PUBLIC_SCHEME}"
  CLICKPIE_API_URL_PUBLIC_PORT="${CLICKPIE_SERVER_URL_PUBLIC_PORT}"
  CLICKPIE_API_URL_PUBLIC_HOSTNAME="${CLICKPIE_SERVER_URL_PUBLIC_HOSTNAME}"
  CLICKPIE_API_URL_PUBLIC="${CLICKPIE_API_URL_PUBLIC_SCHEME}"://"${CLICKPIE_API_URL_PUBLIC_HOSTNAME}":"${CLICKPIE_API_URL_PUBLIC_PORT}"/api/"${API_VVERSION}"
  # local url
  CLICKPIE_API_URL_LOCAL_SCHEME="${CLICKPIE_SERVER_URL_LOCAL_SCHEME}"
  CLICKPIE_API_URL_LOCAL_PORT="${CLICKPIE_SERVER_URL_LOCAL_PORT}"
  CLICKPIE_API_URL_LOCAL_HOSTNAME="${CLICKPIE_SERVER_URL_LOCAL_HOSTNAME}"
  CLICKPIE_API_URL_LOCAL="${CLICKPIE_API_URL_LOCAL_SCHEME}"://"${CLICKPIE_API_URL_LOCAL_HOSTNAME}":"${CLICKPIE_API_URL_LOCAL_PORT}"/api/"${API_VVERSION}"

  define_env
  makefile
  configure_clickpie_server
  cleanup
}

expand() {
  echo ${!1}
}

makefile() {
  printf "Generating Makefile...|%s\n" "$out_makefile"
  m4 $out_macrosfile $in_makefile > $out_makefile
}

configure_clickpie_server() {
  printf "Configuring clickpie-server...\n"
  cd clickpie-server || exit 1
  PKGDIR=.
  PKGDIR_ABS=$(pwd)
  SRCDIR=${PKGDIR}/src
  SRCDIR_ABS=${PKGDIR_ABS}/src
  BUILDIR=${PKGDIR}/build
  BUILDIR_ABS=${PKGDIR_ABS}/build
  CACHEDIR=${PREFIX}/var
  TEMPDIR=${PREFIX}/var
  CONFDIR=${PREFIX}/config
  define_env
  makefile
}

cleanup() {
  rm $pre_config_env
  rm $post_config_env
}

useparseurl() {
  read -r scheme hostname port < <(parseUrl "http://localhost:5173")
  echo $scheme $hostname $port
}

parseUrl() {
  url=$1
  scheme="$(echo "$url" | grep -Eo "^.*://" -)"
  scheme="${scheme%%:*}"
  hostname="$(echo "$url" | grep -Eo "(://[a-zA-Z0-9._-]+(:[0-9]+|/|$)|@[a-zA-Z0-9._-]+(:|/|$))")"
  hostname="${hostname##*/}"
  hostname="${hostname#*@}"
  hostname="${hostname%:*}"
  port="$(echo "$url" | grep -Eo ":[0-9]+(/|$)")"
  port="${port#*:}"
  echo "$scheme" "$hostname" "$port"
}

define_env() {
  printf "Defining environment...|%s\n" "$out_envfile"
  printenv > $post_config_env
  rm -f $out_envfile
  local unquoted_envars=$(mktemp)
  diff --normal $pre_config_env $post_config_env | grep '^>' | cut -c3- | sort > $unquoted_envars
  while IFS='=' read -r k v; do
    # Quote values
    if [[ "$v" =~ \' ]]; then
      printf "%s=\"%s\"\n" "$k" "$v" >> $out_envfile
    else
      printf "%s='%s'\n" "$k" "$v" >> $out_envfile
    fi
  done < $unquoted_envars

  rm -f $out_macrosfile
  while IFS='=' read -r key value; do
    cat <<EOF >> $out_macrosfile
define(\`IN_$key', \`$value')dnl
EOF
  done < $unquoted_envars
}

parse_args(){
  declare -ga POSARGS=()
  while (($# > 0)); do
    case "${1:-}" in
      -r* | -r=* | --run=* | --run*)
        command=$(parse_param "$@") || shift $?
        $command "${@:2}"
        exit 0
        ;;
      --server-public-url=* | --server-public-url*)
        CLICKPIE_SERVER_URL_PUBLIC="$(parse_param "$@")" || shift $?
        ;;
      --server-local-url=* | --server-local-url*)
        CLICKPIE_SERVER_URL_LOCAL="$(parse_param "$@")" || shift $?
        ;;
      --with-clickup-target=* | --with-clickup-target*)
        WITH_CLICKUP_TARGET="$(parse_param "$@")" || shift $?
        ;;
      --with-deploy-target=* | --with-deploy-target*)
        WITH_DEPLOY_TARGET="$(parse_param "$@")" || shift $?
        ;;
      --with-gcloud-target=* | --with-gcloud-target*)
        WITH_GCLOUD_TARGET="$(parse_param "$@")" || shift $?
        ;;
      --prefix=* | --prefix*)
        PREFIX="$(parse_param "$@")" || shift $?
        ;;
      --loglevel=* | --loglevel*)
        LOGLEVEL="$(parse_param "$@")" || shift $?
        ;;
      -C | --config=* | --config*)
        CONFIG="$(parse_param "$@")" || shift $?
        ;;
      -d | --debug)
        DEBUG=0
        ;;
      -h | --help)
        usage
        exit 0
        ;;
      -[a-zA-Z][a-zA-Z]*)
        local i="${1:-}"
        shift
        local rest="$@"
        set --
        for i in $(echo "$i" | grep -o '[a-zA-Z]'); do
          set -- "$@" "-$i"
        done
        set -- $@ $rest
        continue
        ;;
      --)
        shift
        POSARGS+=("$@")
        ;;
      -[a-zA-Z]* | --[a-zA-Z]*)
        error "Unrecognized argument ${1:-}"
        ;;
      *)
        POSARGS+=("${1:-}")
        ;;
    esac
    shift
  done
}

parse_param() {
  local param arg
  local -i toshift=0

  if (($# == 0)); then
    return $toshift
    # param = value
  elif [[ "$1" =~ .*=.* ]]; then
    param="${1%%=*}"
    arg="${1#*=}"
    # param value
  elif [[ "${2-}" =~ ^[^-].+ ]]; then
    param="$1"
    arg="$2"
    ((toshift++))
  fi

  if [[ -z "${arg-}" && ! "${OPTIONAL-}" ]]; then
    fatal "${param:-$1} requires an argument"
  fi

  echo "${arg:-}"
  return $toshift
}

quote() {
  echo \'"$@"\'
}

error() {
  echo "$@"
  exit 1
}

debug() {
  [ ! $DEBUG ] && return
  echo debug: "$@" >&2
}

debug_script_params() {
  debug "Output format: $(quote $_OUTPUT_FORMAT)"
  debug "Verbosity: $(quote $_VERBOSE)"
  debug "Clickup Authorization token: $(quote $_USER_AUTH_TOKEN)"
  debug "Clickup API prefix: $(quote $_CLICKUP_API_PREFIX)"
  debug "Script json2csv: $(quote $_JSON2CSV)"
  debug "Script commons: $(quote $_SCRIPT_COMMONS)"
  debug "Workspace: $(quote $_WORKSPACE_ID)"
  debug "Space: $(quote $_SPACE_ID)"
  debug "Folder: $(quote $_FOLDER_ID)"
  debug "List: $(quote $_LIST_ID)"
}

main "$@"

## Local Variables:
## mode: script-mode
## End:
