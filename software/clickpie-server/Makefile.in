#!/usr/bin/make

# Make config
SHELL:=/usr/bin/bash
.DEFAULT_GOAL:=all
.DELETE_ON_ERROR:
.EXPORT_ALL_VARIABLES:
.SECONDEXPANSION:
.ONESHELL:

##################################################
# Module directories
##################################################
srcdir_top=IN_SRCDIR
srcdir_top_abs=IN_SRCDIR_ABS
srcdir=$(srcdir_top)/src
srcdir_abs=$(srcdir_top_abs)/src
buildir_top=IN_CONFIGUREDIR
buildir_top_abs=IN_CONFIGUREDIR_ABS
buildir=IN_BUILDIR
buildir_abs=IN_BUILDIR_ABS

##################################################
# Tools and their configurations
##################################################
esbuild=npx esbuild

##################################################
# Inputs output
##################################################
in_clickpie_server=$(srcdir)/clickpie-server.js
out_clickpie_server=clickpie-server.js

##################################################
# Build
##################################################
build: | $(buildir_abs)
	$(esbuild) --bundle $(in_clickpie_server) \
	--outdir=$(buildir) --platform=node --packages=external \
	--target=esnext --format=esm

##################################################
# Directories
##################################################
$(buildir_abs):
	mkdir -p $@

##################################################
# help
##################################################
help:
	@cat ./Makefile | grep -i --color=auto 'phony' | cut -d ' ' -f2- | tail --lines=+3

# Software development
.PHONY: run # read dotenvfile and run any file
.PHONY: scratch # read dotenvfile and run the scratch file
.PHONY: build # build application
.PHONY: start # start application
.PHONY: stop # stop application
# Software distribution
.PHONY: deploy # deploy the application to the consumer, such as a server
# Cleaning
.PHONY: clean # Remove files created by make targets
.PHONY: distclean # Remove files created by configure
# Misc
.PHONY: help
.PHONY: dotenv # write environment into .env
.PHONY: all # default target
